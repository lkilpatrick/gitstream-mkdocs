# Post installation instructions

## Insert workflow automation files to your repo

!!! attention

    To start using gitStream, create the following files in each repo's main branch with the following content.

Get the following files into each of your repos main branch:

1. `.cm/gitstream.cm` 
2. `.github/workflows/gitstream.yml`

#### `.cm/gitstream.cm`
This file should be updated with new rules and automations. 

```yaml title=".cm/gitstream.cm"
# -*- mode: yaml -*-

manifest:
  version: 1.0

# The `automations` section includes a list of automation that applies 
# to the repo in which gitStream is installed. Each automation has an 
# `if` key with a list of the necessary assertions, as well as a `run` key with a
# list of all actions. All the listed assertions need to pass in order 
# for the following actions to be executed (there is AND relation between conditions).

# Each automation under the `automations` section is independent of the others. 
# Every time a PR is opened or changed, the automation's conditions are evaluated (the `if`). 
# The actions under `run` are executed one by one if all the conditions pass. 

# Conditions consists of an expression, which are wrapped with double curly braces, and 
# includes a context variable like `files` and filter functions like `length`. Filters 
# functions are essentially functions that can be applied to context variables. They are 
# called with a pipe operator (|) and can take arguments. Read more on 
# [Filter functions page](https://linear-b.github.io/gitstream-mkdocs/23_gitstream-filters/).

automations:
  # This is the name of the automation, the name should meaningful
  mark_formatting:
    # the `if` key has a list of conditions
    if:
      # Check for every changed file if only formatting changes were made 
      # Read more on [isformattingchange](https://linear-b.github.io/gitstream-mkdocs/23_gitstream-filters/#isformattingchange-filter)
      - {{ source.diff.files | allFormattingChange }}
    # the `run` key has a list of actions
    run: 
      # Apply the label 'formatting' once the conditions are met 
      - action: add-labels@v1
        args:
          labels: ['formatting']
  mark_docs:
    if:
      # Check for every changed file if is a document file. The allDocs filter checks for 
      # common file extensions used for documents.
      # Read more on [isformattingchange](https://linear-b.github.io/gitstream-mkdocs/23_gitstream-filters/#alldocs-filter)
      - {{ files | allDocs }}
    run: 
      - action: add-labels@v1
        args:
          labels: ['docs']
  mark_tests:
    if:
      # Check for every changed file if is a test file. The allTests filter checks for 
      # the substring `test` or `spec` in the file path or file name.
      # Read more on [isformattingchange](https://linear-b.github.io/gitstream-mkdocs/23_gitstream-filters/#alltests-filter)
      - {{ files | allTests }}
    run: 
      - action: add-labels@v1
        args:
          labels: ['tests']
  mark_complex_pr:
    if:
      # It's possible to check if either a one of few conditions pass (OR relation) by using
      # the `or` expression. Here the PR complexity is checked, one condition for complex PRs  
      # is the number of files, checked using the [`length` filter function](https://mozilla.github.io/nunjucks/templating.html#length)
      # OR
      # use the dedictaed filter that calcualtes the estimated review time filter function
      # based on a statstical model, read more on [estimatedReviewTime](https://linear-b.github.io/gitstream-mkdocs/23_gitstream-filters/#estimatedreviewtime-filter)
      - {{ (files | length >= 10) or (branch | estimatedReviewTime >= 20) }}
    run:
      - action : add-labels@v1
        args:
          labels: ['long-review']
```

!!! note

    You can edit later the `.cm/gitstream.cm` and add your own checks and automations.

#### `.github/workflows/gitstream.yml`

This file is used by gitStream to trigger the automation in GitHub, you should not edit it. Editing 
it might break the functionality or might not be compatible with future changes in gitStream. 

```yaml title=".github/workflows/gitstream.yml"
# Code generated by gitStream GitHub app - DO NOT EDIT

name: gitStream workflow automation

on:
  workflow_dispatch:
    inputs:
      client_payload:
          description: The Client payload
          required: true
      full_repository:
          description: the repository name include the owner in `owner/repo_name` format
          required: true
      head_ref:
          description: the head sha
          required: true
      base_ref:
          description: the base ref 
          required: true
      installation_id:
          description: the installation id
          required: false
      resolver_url:
          description: the resolver url to pass results to
          required: true
      resolver_token:
          description: Optional resolver token for resolver service
          required: false
          default: ''

jobs:
  gitStream:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    name: gitStream workflow automation
    steps:
      - name: Evaluate Rules
        uses: linear-b/gitstream-github-action@v1
        id: rules-engine
        with:
          full_repository: ${{ github.event.inputs.full_repository }}
          head_ref: ${{ github.event.inputs.head_ref }}
          base_ref: ${{ github.event.inputs.base_ref }}
          client_payload: ${{ github.event.inputs.client_payload }}
          installation_id: ${{ github.event.inputs.installation_id }}
          resolver_url: ${{ github.event.inputs.resolver_url }}
          resolver_token: ${{ github.event.inputs.resolver_token }}
```

## Set GitHub repo settings

!!! attention

    To get the full potential using gitStream, you need to set it as a required check.

To make sure gitStream can block PRs from merging under certain conditions, you should set the following:

1. Go to repo `settings`
2. On the left pane select `Code and automation` > `Branches` 
3. Set `Branch protection rules` for your desired branch 
4. Enable `Require status checks to pass before merging`
5. Search for `status checks in the last week for this repository`
6. Select `gitStream.cm` as required check
