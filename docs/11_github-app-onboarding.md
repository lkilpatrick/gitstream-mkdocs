# Post installation instructions

## Insert workflow automation files to your repo

!!! attention

    To start using gitStream, create the following files in each repo's main branch with the following content.

Get the following files into each of your repos main branch:
1. `.cm/gitstream.cm` 
2. `.github/workflows/gitstream.yml`

#### `.cm/gitstream.cm`
This file should be updated with new rules and automations. 

```yaml title=".cm/gitstream.cm"
# -*- mode: yaml -*-

manifest:
  version: 1.0

# Define condition under the `checks` section, each check consists of
# an expression. The checks results are evalauated and used as conditions 
# for the next section `automations`. 
# Checks expressions are wrapped with double curly braces and includes a
# context variable like `files` and filter like `length`.
# Filters are essentially functions that can be applied to variables. They 
# are called with a pipe operator (|) and can take arguments.
checks:
  complexity:
    by:
      many_files: {{ files | length >= 10 }}
      review_time: {{ branch | estimatedReviewTime >= 20 }}
  change:
    is:
      formatting_only: {{ source.diff.files | allFormattingChange }}
      docs_only: {{ files | allDocs }}
      tests_only: {{ files | allTests }}
  
# The `automations` section include the list of automation that applies 
# for the repo in which gitStream is installed. 
# Each autaomtion has `if` key with a list of the necessary condtions and
# a `run` key with a list of all actions. All the listed condtions need to  
# pass in order for the following actions to be executed.
automations:
  mark_formatting:
    if:
      - {{ checks.change.is.formatting_only }}
    run: 
      - action : add-labels@v1
        args:
          labels: ['formatting']
  mark_docs:
    if:
      - {{ checks.change.is.docs_only }}
    run: 
      - action : add-labels@v1
        args:
          labels: ['docs']
  mark_tests:
    if:
      - {{ checks.change.is.tests_only }}
    run: 
      - action : add-labels@v1
        args:
          labels: ['tests']          
  mark_complex_pr:
    if:
      - {{ checks.complexity.by.many_files or checks.complexity.by.review_time }}
    run:
      - action : add-labels@v1
        args:
          labels: ['complex-pr']
```

#### `.github/workflows/gitstream.yml`
This file is used by gitStream to trigger the automation in GitHub, you should not edit it. Editing 
it might break the functionality or might not be compatible with future changes in gitStream. 

```yaml title=".github/workflows/gitstream.yml"
# Code generated by gitStream GitHub app - DO NOT EDIT

name: gitStream workflow automation

on:
  workflow_dispatch:
    inputs:
      client_payload:
          description: The Client payload
          required: true
      full_repository:
          description: the repository name include the owner in `owner/repo_name` format
          required: true
      head_ref:
          description: the head sha
          required: true
      base_ref:
          description: the base ref 
          required: true
      installation_id:
          description: the installation id
          required: false
      resolver_url:
          description: the resolver url to pass results to
          required: true
      resolver_token:
          description: Optional resolver token for resulver service
          required: false
          default: ''

jobs:
  continuous-merge-rules:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    name: gitStream workflow automation
    steps:
      - name: Evaluate Rules
        uses: linear-b/gitstream-github-action@v1
        id: rules-engine
        with:
          full_repository: ${{ github.event.inputs.full_repository }}
          head_ref: ${{ github.event.inputs.head_ref }}
          base_ref: ${{ github.event.inputs.base_ref }}
          client_payload: ${{ github.event.inputs.client_payload }}
          installation_id: ${{ github.event.inputs.installation_id }}
          resolver_url: ${{ github.event.inputs.resolver_url }}
          resolver_token: ${{ github.event.inputs.resolver_token }}
```

## Set GitHub repo settings

!!! attention

    To get the full potnetial using gitStream, you need to set it as required check.

To make sure gitStream can block PRs from merging under certain conditions you should set the following:

1. Go to repo `settings`
2. On the left pane select `Code and automation` > `Branches` 
3. Set `Branch protection rules` for your desired branch 
4. Enable `Require status checks to pass before merging`
5. Enable `Require branches to be up to date before merging`
6. Search for `status checks in the last week for this repository`
7. Select `gitStream.cm` as required check
